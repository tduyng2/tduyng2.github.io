<!doctype html><html lang=en><head><meta charset=utf-8><meta content=dark name=color-scheme><meta content="ie=edge" http-equiv=x-ua-compatible><meta content="width=device-width,initial-scale=1" name=viewport><meta content=https://tduyng2.github.io name=base><meta content=True name=HandheldFriendly><meta content=yes name=mobile-web-app-capable><meta content=yes name=apple-mobile-web-app-capable><meta content=default name=apple-mobile-web-app-status-bar-style><meta content="index, nofollow" name=robots><meta content="Explore the process of enhancing website speed through image conversion to WebP using Rust" name=description><title>Transforming website images into WebP with Rust for faster loading times</title><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><meta content="Transforming website images into WebP with Rust for faster loading times" property=og:title><meta content=article property=og:type><meta content="Duy NG" property=og:site_name><meta content="Explore the process of enhancing website speed through image conversion to WebP using Rust" name=description><meta content="Explore the process of enhancing website speed through image conversion to WebP using Rust" property=og:description><meta content="https://tduyng2.github.io/blog/rust-webp-transform/img/page_speed.webp?h=16e47f8eaa4c84f958f0" property=og:image><meta content=904 property=og:image:width><meta content=483 property=og:image:height><meta content="https://tduyng2.github.io/blog/rust-webp-transform/img/page_speed.webp?h=16e47f8eaa4c84f958f0" name=twitter:image><meta content=summary_large_image name=twitter:card><style>body{--primary-color:#5871a2;--primary-pale-color:#5871a210;--text-color:#3c4043;--text-pale-color:#94969f;--bg-color:#fff;--highlight-mark-color:#5f75b035;--callout-note-color:#5871a2;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body.dark{--primary-color:#447dbf;--primary-pale-color:#5d77ac20;--text-color:#a5abba;--text-pale-color:#a5abba;--bg-color:#202124;--highlight-mark-color:#5f75b035;--callout-note-color:#5d77ac;--callout-important-color:#8062b0;--callout-warning-color:#936e51;--callout-alert-color:#bc5252;--callout-question-color:#477389;--callout-tip-color:#3c8460}body{--main-font:ui-sans-serif,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--code-font:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;--homepage-max-width:768px;--main-max-width:768px;--avatar-size:60px;--icon-size:20px;--homepage-font-size:16px;--homepage-line-height:1.75;--paragraph-font-size:16px;--paragraph-line-height:1.75;--aside-font-size:15px;--img-border-radius:0px;--callout-border-radius:0px;--detail-border-radius:0px;--dark-mode-img-brightness:.75;--dark-mode-chart-brightness:.75;--inline-code-border-radius:2px;--inline-code-bg-color:var(--primary-pale-color);--block-code-border-radius:0px;--block-code-border-color:var(--primary-color);--detail-border-color:var(--primary-color)}</style><link href=/main.css rel=stylesheet><script async data-do-not-track=true data-website-id=0403ec1f-fbf8-4e6c-b24b-0c585ca25873 defer src=https://analytics.eu.umami.is/script.js></script><body class=post><script>const theme=sessionStorage.getItem(`theme`);const match=window.matchMedia(`(prefers-color-scheme: dark)`).matches;if(theme&&theme==`dark`||!theme&&match){document.body.classList.add(`dark`);const a=document.querySelector(`link#hl`);if(a)a.href=`/hl-dark.css`}</script><header class=blur><div id=header-wrapper><nav><a class=instant href=/>tduyng</a><button aria-label="toggle expand" class=separator id=toggler>::</button><span class="wrap left fold">{</span><a class=instant href=/blog>blog</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/projects>projects</a><span class="wrap-separator fold">,</span><a class="instant fold" href=/about>about</a><span class="wrap right fold">} ;</span></nav><div id=btns><a aria-label="rss feed" href=/atom.xml id=rss-btn><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 17C5.20914 17 7 18.7909 7 21H3V17ZM3 10C9.07513 10 14 14.9249 14 21H12C12 16.0294 7.97056 12 3 12V10ZM3 3C12.9411 3 21 11.0589 21 21H19C19 12.1634 11.8366 5 3 5V3Z" fill=currentColor></path></svg></a><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><dialog id=rss-mask><div><a href=https://tduyng2.github.io/atom.xml>https://tduyng2.github.io/atom.xml</a><button data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' aria-label=copy autofocus data-link=https://tduyng2.github.io/atom.xml><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill=currentColor></path></svg></button></div></dialog><div id=wrapper><div id=blank></div><aside><nav><ul><li><a class=h2 href=#converting-images-to-webp-with-rust>Converting images to WebP with Rust</a><li><a class=h2 href=#addressing-generated-image-size-issues>Addressing generated image size issues</a></ul></nav><button aria-label="back to top" id=back-to-top><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M11.9997 10.8284L7.04996 15.7782L5.63574 14.364L11.9997 8L18.3637 14.364L16.9495 15.7782L11.9997 10.8284Z" fill=currentColor></path></svg></button></aside><main><div><div data-check-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M10.0007 15.1709L19.1931 5.97852L20.6073 7.39273L10.0007 17.9993L3.63672 11.6354L5.05093 10.2212L10.0007 15.1709Z" fill="currentColor"></path></svg>' data-copy-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M6.9998 6V3C6.9998 2.44772 7.44752 2 7.9998 2H19.9998C20.5521 2 20.9998 2.44772 20.9998 3V17C20.9998 17.5523 20.5521 18 19.9998 18H16.9998V20.9991C16.9998 21.5519 16.5499 22 15.993 22H4.00666C3.45059 22 3 21.5554 3 20.9991L3.0026 7.00087C3.0027 6.44811 3.45264 6 4.00942 6H6.9998ZM5.00242 8L5.00019 20H14.9998V8H5.00242ZM8.9998 6H16.9998V16H18.9998V4H8.9998V6Z" fill="currentColor"></path></svg>' id=copy-cfg style=display:none></div><article data-backlink-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20"><path d="M9.41421 8L18.0208 16.6066L16.6066 18.0208L8 9.41421V17H6V6H17V8H9.41421Z" fill="currentColor"></path></svg>' class=prose><h1>Transforming website images into WebP with Rust for faster loading times</h1><div id=post-info><div id=date><span id=publish>2024-05-23</span></div><div id=tags><a class=instant href=https://tduyng2.github.io/tags/performance><span>#</span>performance</a><a class=instant href=https://tduyng2.github.io/tags/rust><span>#</span>rust</a><a class=instant href=https://tduyng2.github.io/tags/webp><span>#</span>webp</a><a class=instant href=https://tduyng2.github.io/tags/image-conversion><span>#</span>image-conversion</a><a class=instant href=https://tduyng2.github.io/tags/cli><span>#</span>cli</a></div></div><blockquote class="callout alert hidden" data-alert-text-after=" days ago and may be out of date." data-alert-text-before="This article was last updated " data-days=1000 id=outdate_alert><div class=icon><svg viewbox="0 0 24 24" height=20 width=20 xmlns=http://www.w3.org/2000/svg><path d="M4.00098 20V14C4.00098 9.58172 7.5827 6 12.001 6C16.4193 6 20.001 9.58172 20.001 14V20H21.001V22H3.00098V20H4.00098ZM6.00098 20H18.001V14C18.001 10.6863 15.3147 8 12.001 8C8.68727 8 6.00098 10.6863 6.00098 14V20ZM11.001 2H13.001V5H11.001V2ZM19.7792 4.80761L21.1934 6.22183L19.0721 8.34315L17.6578 6.92893L19.7792 4.80761ZM2.80859 6.22183L4.22281 4.80761L6.34413 6.92893L4.92991 8.34315L2.80859 6.22183ZM7.00098 14C7.00098 11.2386 9.23956 9 12.001 9V11C10.3441 11 9.00098 12.3431 9.00098 14H7.00098Z" fill=currentColor></path></svg></div><div class=content></div></blockquote><p>Hi everyone 👋,<p>Recently, I attended <a rel="nofollow noreferrer" href=https://www.ekino.fr/>Ekinoday</a>, our company’s annual conference, where my colleagues share knowledge on various topics, from technology to life tips. This event is always very interesting for me.<p>I had a chance to talk with my colleague <a rel="nofollow noreferrer" href=https://github.com/thovo>Raphaël Tho Vo</a>, who gave a presentation on optimising web performance. <a rel="nofollow noreferrer" href=https://github.com/thovo>Raphaël</a> mentioned that many people don’t realise how much image size and format can effect the web performance. Large image files can slow down a website significantly, affecting user experience.<p>Raphaël explained that we can improve performance by using better image formats. He mentioned several modern formats like <a rel="nofollow noreferrer" href=https://www.smashingmagazine.com/2021/09/modern-image-formats-avif-webp/>AVIF, WebP, JPEG 2000</a>. Among these, AVIF and WebP are the most supported by web browsers today.<p>Inspired by Raphaël’s advice, I decided to take a closer look at my website's performance. I host my site on GitHub, using <a rel="nofollow noreferrer" href=https://www.getzola.org/>Zola</a>, a static site engine, along with the <a rel="nofollow noreferrer" href=https://github.com/welpo/tabi>Tabi</a> theme. This theme is beautifully designed and well-coded.<p>I tested my website with <a rel="nofollow noreferrer" href=https://pagespeed.web.dev/>PageSpeed Insights</a> and got a perfect score of 100/100 in everything: Performance, Accessibility, Best Practices, and SEO.<p><img alt="page speed" loading=lazy src=img/page_speed.webp><br><p>However, I noticed that I still use a lot of PNG and JPEG images. Switching to WebP could significantly decrease image sizes and improve more load times.<h3 id=converting-images-to-webp-with-rust>Converting images to WebP with Rust<a aria-label="Anchor link for: converting-images-to-webp-with-rust" class=zola-anchor href=#converting-images-to-webp-with-rust style=visibility:hidden>#</a></h3><p>How can we accomplish this?<p>To optimise images, I had to convert them to WebP format. I chose this format because it's effective and widely supported across different web browsers. But I needed a quick way to convert multiple images to WebP and reuse it multiple times.<p>There are online tools available to help, but that's not the solution I'm looking for at the moment. Instead, I've chosen to create my own solution using Rust. Rust is great for this because it's fast and easy to use for simple programs. Making this program will help me learn more about Rust.<p>The objectif is to convert all kinds of images into WebP with just one command, making it fast and easy.<p>Now, let's coding!<p>For this program, I used the <a rel="nofollow noreferrer" href=https://github.com/image-rs/image>image</a> crate for decoding and encoding images. This crate supports many different image formats:<table><thead><tr><th>Format<th>Decoding<th>Encoding<tbody><tr><td>AVIF<td>Yes (8-bit only) *<td>Yes (lossy only)<tr><td>BMP<td>Yes<td>Yes<tr><td>Farbfeld<td>Yes<td>Yes<tr><td>GIF<td>Yes<td>Yes<tr><td>HDR<td>Yes<td>Yes<tr><td>ICO<td>Yes<td>Yes<tr><td>JPEG<td>Yes<td>Yes<tr><td>EXR<td>Yes<td>Yes<tr><td>PNG<td>Yes<td>Yes<tr><td>PNM<td>Yes<td>Yes<tr><td>QOI<td>Yes<td>Yes<tr><td>TGA<td>Yes<td>Yes<tr><td>TIFF<td>Yes<td>Yes<tr><td>WebP<td>Yes<td>Yes (lossless only)</table><p>**To encode an image to WebP, I created a function <code>encode_webp</code>:<pre class=language-rust data-lang=rust style=color:#f8f8f2;background-color:#282a36><code class=language-rust data-lang=rust><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>image</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{</span><span>DynamicImage, WebPEncoder, ExtendedColorType</span><span style=color:#fff>}</span><span>;
</span><span>
</span><span style=color:#ff79c6>pub </span><span style=color:#8be9fd;font-style:italic>fn </span><span style=color:#50fa7b>encode_webp</span><span>(</span><span style=color:#ffb86c;font-style:italic>image</span><span>: </span><span style=color:#ff79c6>&</span><span>DynamicImage) </span><span style=color:#ff79c6>-> </span><span style=color:#66d9ef;font-style:italic>Result</span><span style=color:#ff79c6><</span><span style=color:#66d9ef;font-style:italic>Vec</span><span style=color:#ff79c6><</span><span style=color:#8be9fd;font-style:italic>u8</span><span style=color:#ff79c6>>, </span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#ff79c6>> </span><span style=color:#fff>{
</span><span>    </span><span style=color:#6272a4>// Convert the image to RGBA format
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> rgba_image </span><span style=color:#ff79c6>=</span><span> image</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>to_rgba8</span><span>();
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let </span><span style=color:#ff79c6>mut</span><span> webp_data </span><span style=color:#ff79c6>= </span><span style=color:#66d9ef;font-style:italic>Vec</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>new();
</span><span>    </span><span style=color:#6272a4>// Create a WebP encoder (support only lossless feature for now)
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> encoder </span><span style=color:#ff79c6>= </span><span style=color:#66d9ef;text-decoration:underline>WebPEncoder</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>new_lossless(</span><span style=color:#ff79c6>&mut</span><span> webp_data);
</span><span>    encoder
</span><span>        </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>encode</span><span>(
</span><span>            rgba_image</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>as_raw</span><span>(),
</span><span>            rgba_image</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>width</span><span>(),
</span><span>            rgba_image</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>height</span><span>(),
</span><span>            </span><span style=color:#66d9ef;text-decoration:underline>ExtendedColorType</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>Rgba8, </span><span style=color:#6272a4>// Image crate support only Rgb8 or Rgba8 data
</span><span>        )
</span><span>        </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>map_err</span><span>(|</span><span style=color:#ffb86c;font-style:italic>e</span><span>| format!(</span><span style=color:#f1fa8c>"</span><span style=color:#bd93f9>{e}</span><span style=color:#f1fa8c>"</span><span>))</span><span style=color:#ff79c6>?</span><span>;
</span><span>
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Ok</span><span>(webp_data)
</span><span style=color:#fff>}
</span></code></pre><p>The <code>DynamicImage</code> type from <a rel="nofollow noreferrer" href=https://github.com/image-rs/image>image</a> crate allows us to handle different image formats. I convert the image to RGBA format and use the WebPEncoder to encode it.<p><strong>Next, I wrote a function to convert a single image</strong>:<pre class=language-rust data-lang=rust style=color:#f8f8f2;background-color:#282a36><code class=language-rust data-lang=rust><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>image</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#66d9ef;text-decoration:underline>io</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>Reader;
</span><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>std</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{</span><span>fs, </span><span style=color:#66d9ef;text-decoration:underline>path</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>Path</span><span style=color:#fff>}</span><span>;
</span><span>
</span><span style=color:#8be9fd;font-style:italic>fn </span><span style=color:#50fa7b>convert_image</span><span>(</span><span style=color:#ffb86c;font-style:italic>input_path</span><span>: </span><span style=color:#ff79c6>&</span><span>Path, </span><span style=color:#ffb86c;font-style:italic>output_dir</span><span>: </span><span style=color:#ff79c6>&</span><span style=color:#66d9ef;font-style:italic>Option</span><span><</span><span style=color:#66d9ef;font-style:italic>String</span><span>>) </span><span style=color:#ff79c6>-> </span><span style=color:#66d9ef;font-style:italic>Result</span><span style=color:#ff79c6><(), </span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#ff79c6>> </span><span style=color:#fff>{
</span><span>    </span><span style=color:#6272a4>// Open and decode the image
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> image_render </span><span style=color:#ff79c6>=
</span><span>        </span><span style=color:#66d9ef;text-decoration:underline>Reader</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>open(input_path)</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>map_err</span><span>(|</span><span style=color:#ffb86c;font-style:italic>e</span><span>| format!(</span><span style=color:#f1fa8c>"Failed to open image: </span><span style=color:#bd93f9>{}</span><span style=color:#f1fa8c>"</span><span>, e))</span><span style=color:#ff79c6>?</span><span>;
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> image </span><span style=color:#ff79c6>=</span><span> image_render
</span><span>        </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>decode</span><span>()
</span><span>        </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>map_err</span><span>(|</span><span style=color:#ffb86c;font-style:italic>e</span><span>| format!(</span><span style=color:#f1fa8c>"Failed to decode image: </span><span style=color:#bd93f9>{}</span><span style=color:#ff79c6>\n</span><span style=color:#f1fa8c>"</span><span>, e))</span><span style=color:#ff79c6>?</span><span>;
</span><span>    
</span><span>    </span><span style=color:#6272a4>// Encode the image to WebP
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> webp_data </span><span style=color:#ff79c6>= </span><span style=color:#8be9fd>encode_webp</span><span>(</span><span style=color:#ff79c6>&</span><span>image)</span><span style=color:#ff79c6>?</span><span>;
</span><span>
</span><span>    </span><span style=color:#6272a4>// Determine the output path
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> output_path </span><span style=color:#ff79c6>= if </span><span style=color:#8be9fd;font-style:italic>let </span><span style=color:#66d9ef;font-style:italic>Some</span><span>(output_dir) </span><span style=color:#ff79c6>=</span><span> output_dir </span><span style=color:#fff>{
</span><span>        </span><span style=color:#66d9ef;text-decoration:underline>Path</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>new(output_dir)
</span><span>            </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>join</span><span>(input_path</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>file_stem</span><span>()</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>unwrap</span><span>())
</span><span>            </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>with_extension</span><span>(</span><span style=color:#f1fa8c>"webp"</span><span>)
</span><span>    </span><span style=color:#fff>} </span><span style=color:#ff79c6>else </span><span style=color:#fff>{
</span><span>        input_path</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>with_extension</span><span>(</span><span style=color:#f1fa8c>"webp"</span><span>)
</span><span>    </span><span style=color:#fff>}</span><span>;
</span><span>
</span><span>    </span><span style=color:#6272a4>// Write the WebP image to the output path
</span><span>    </span><span style=color:#66d9ef;text-decoration:underline>fs</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>write(output_path</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>clone</span><span>(), webp_data</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>to_vec</span><span>())
</span><span>        </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>map_err</span><span>(|</span><span style=color:#ffb86c;font-style:italic>e</span><span>| format!(</span><span style=color:#f1fa8c>"Failed to write WebP file: </span><span style=color:#bd93f9>{}</span><span style=color:#f1fa8c>"</span><span>, e))</span><span style=color:#ff79c6>?</span><span>;
</span><span>
</span><span>    println!(</span><span style=color:#f1fa8c>"Generated: </span><span style=color:#bd93f9>{}</span><span style=color:#f1fa8c>"</span><span>, output_path</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>display</span><span>());
</span><span>
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Ok</span><span>(())
</span><span style=color:#fff>}
</span><span>
</span></code></pre><p>This function first opens and decodes the image, then encodes it to WebP format using the previously defined <code>encode_webp</code> function. Finally, it writes the resulting WebP image to either the specified output directory or the same location as the original image.<p><strong>To convert all images in a directory, I created a function <code>convert_images</code>:</strong><pre class=language-rust data-lang=rust style=color:#f8f8f2;background-color:#282a36><code class=language-rust data-lang=rust><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>image</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{</span><span style=color:#66d9ef;text-decoration:underline>io</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>Reader, DynamicImage</span><span style=color:#fff>}</span><span>;
</span><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>rayon</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#66d9ef;text-decoration:underline>prelude</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#ff79c6>*</span><span>;
</span><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>std</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{
</span><span>    fs,
</span><span>    </span><span style=color:#66d9ef;text-decoration:underline>path</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>Path,
</span><span style=color:#fff>}</span><span>;
</span><span>
</span><span style=color:#8be9fd;font-style:italic>fn </span><span style=color:#50fa7b>convert_images</span><span>(</span><span style=color:#ffb86c;font-style:italic>path</span><span>: </span><span style=color:#ff79c6>&</span><span>Path, </span><span style=color:#ffb86c;font-style:italic>output_dir</span><span>: </span><span style=color:#ff79c6>&</span><span style=color:#66d9ef;font-style:italic>Option</span><span><</span><span style=color:#66d9ef;font-style:italic>String</span><span>>) </span><span style=color:#ff79c6>-> </span><span style=color:#66d9ef;font-style:italic>Result</span><span style=color:#ff79c6><(), </span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#ff79c6>> </span><span style=color:#fff>{
</span><span>    </span><span style=color:#ff79c6>if</span><span> path</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>is_dir</span><span>() </span><span style=color:#fff>{
</span><span>        </span><span style=color:#8be9fd;font-style:italic>let</span><span> entries: </span><span style=color:#66d9ef;font-style:italic>Vec</span><span>&LTPathBuf> </span><span style=color:#ff79c6>= </span><span style=color:#66d9ef;text-decoration:underline>fs</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>read_dir(path)
</span><span>            </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>map_err</span><span>(|</span><span style=color:#ffb86c;font-style:italic>e</span><span>| format!(</span><span style=color:#f1fa8c>"Read directory failed: </span><span style=color:#bd93f9>{e}</span><span style=color:#f1fa8c>"</span><span>))</span><span style=color:#ff79c6>?
</span><span>            </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>filter_map</span><span>(|</span><span style=color:#ffb86c;font-style:italic>entry</span><span>| entry</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>ok</span><span>()</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>map</span><span>(|</span><span style=color:#ffb86c;font-style:italic>e</span><span>| e</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>path</span><span>()))
</span><span>            </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>collect</span><span>();
</span><span>
</span><span>        entries</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>par_iter</span><span>()</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>try_for_each</span><span>(|</span><span style=color:#ffb86c;font-style:italic>path</span><span>| </span><span style=color:#fff>{
</span><span>            </span><span style=color:#ff79c6>if</span><span> path</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>is_dir</span><span>() </span><span style=color:#fff>{
</span><span>                </span><span style=color:#8be9fd>convert_images</span><span>(path, output_dir)
</span><span>            </span><span style=color:#fff>} </span><span style=color:#ff79c6>else if </span><span style=color:#8be9fd>is_supported</span><span>(path) </span><span style=color:#fff>{
</span><span>                </span><span style=color:#8be9fd>convert_image</span><span>(path, output_dir)
</span><span>            </span><span style=color:#fff>} </span><span style=color:#ff79c6>else </span><span style=color:#fff>{
</span><span>                </span><span style=color:#66d9ef;font-style:italic>Ok</span><span>(())
</span><span>            </span><span style=color:#fff>}
</span><span>        </span><span style=color:#fff>}</span><span>)</span><span style=color:#ff79c6>?</span><span>;
</span><span>    </span><span style=color:#fff>}
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Ok</span><span>(())
</span><span style=color:#fff>}
</span><span>
</span><span style=color:#8be9fd;font-style:italic>fn </span><span style=color:#50fa7b>is_supported</span><span>(</span><span style=color:#ffb86c;font-style:italic>path</span><span>: </span><span style=color:#ff79c6>&</span><span>Path) </span><span style=color:#ff79c6>-> </span><span style=color:#8be9fd;font-style:italic>bool </span><span style=color:#fff>{
</span><span>    </span><span style=color:#ff79c6>match </span><span style=color:#66d9ef;text-decoration:underline>fs</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>read(path) </span><span style=color:#fff>{
</span><span>        </span><span style=color:#66d9ef;font-style:italic>Ok</span><span>(data) </span><span style=color:#ff79c6>=> </span><span style=color:#fff>{
</span><span>            </span><span style=color:#ff79c6>if</span><span> path</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>extension</span><span>()</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>unwrap_or_default</span><span>() </span><span style=color:#ff79c6>== </span><span style=color:#f1fa8c>"webp" </span><span style=color:#fff>{
</span><span>                </span><span style=color:#ff79c6>return </span><span style=color:#bd93f9>false</span><span>;
</span><span>            </span><span style=color:#fff>}
</span><span>            </span><span style=color:#66d9ef;text-decoration:underline>image</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>guess_format(</span><span style=color:#ff79c6>&</span><span>data)</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>is_ok</span><span>()
</span><span>        </span><span style=color:#fff>}
</span><span>        </span><span style=color:#66d9ef;font-style:italic>Err</span><span>(</span><span style=color:#ff79c6>_</span><span>) </span><span style=color:#ff79c6>=> </span><span style=color:#bd93f9>false</span><span>,
</span><span>    </span><span style=color:#fff>}
</span><span style=color:#fff>}
</span><span>
</span></code></pre><p>This function checks if the path is a directory. If it is, it reads all entries and recursively processes each one. If the path is an image, it converts it to WebP. The <code>par_iter()</code> method from the <a rel="nofollow noreferrer" href=https://github.com/rayon-rs/rayon>rayon</a> crate enables parallel processing for better performance.<p>Finally, the <code>main</code> function serves as the entry point of the application:<pre class=language-rust data-lang=rust style=color:#f8f8f2;background-color:#282a36><code class=language-rust data-lang=rust><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>clap</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>Parser;
</span><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>image</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{</span><span style=color:#66d9ef;text-decoration:underline>io</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>Reader, DynamicImage</span><span style=color:#fff>}</span><span>;
</span><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>rayon</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#66d9ef;text-decoration:underline>prelude</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#ff79c6>*</span><span>;
</span><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>std</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{
</span><span>    fs,
</span><span>    </span><span style=color:#66d9ef;text-decoration:underline>path</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{</span><span>Path, PathBuf</span><span style=color:#fff>}</span><span>,
</span><span style=color:#fff>}</span><span>;
</span><span>
</span><span>#[derive(Parser, Debug)]
</span><span style=color:#8be9fd;font-style:italic>struct </span><span>CliArgs </span><span style=color:#fff>{
</span><span>    #[clap(short, long)]
</span><span>    </span><span style=color:#fff>dir</span><span>: </span><span style=color:#66d9ef;font-style:italic>Option</span><span><</span><span style=color:#66d9ef;font-style:italic>String</span><span>>,
</span><span>
</span><span>    #[clap(short, long)]
</span><span>    </span><span style=color:#fff>output</span><span>: </span><span style=color:#66d9ef;font-style:italic>Option</span><span><</span><span style=color:#66d9ef;font-style:italic>String</span><span>>,
</span><span style=color:#fff>}
</span><span>
</span><span style=color:#8be9fd;font-style:italic>fn </span><span style=color:#50fa7b>main</span><span>() </span><span style=color:#fff>{
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> args </span><span style=color:#ff79c6>= </span><span style=color:#66d9ef;text-decoration:underline>CliArgs</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>parse();
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> dir </span><span style=color:#ff79c6>=</span><span> args</span><span style=color:#ff79c6>.</span><span>dir</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>unwrap_or_else</span><span>(|| </span><span style=color:#f1fa8c>"."</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>to_string</span><span>());
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> output_dir </span><span style=color:#ff79c6>=</span><span> args</span><span style=color:#ff79c6>.</span><span>output;
</span><span>
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> path </span><span style=color:#ff79c6>= </span><span style=color:#66d9ef;text-decoration:underline>Path</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>new(</span><span style=color:#ff79c6>&</span><span>dir);
</span><span>    </span><span style=color:#ff79c6>if </span><span style=color:#8be9fd;font-style:italic>let </span><span style=color:#66d9ef;font-style:italic>Err</span><span>(e) </span><span style=color:#ff79c6>= </span><span style=color:#8be9fd>convert_images</span><span>(path, </span><span style=color:#ff79c6>&</span><span>output_dir) </span><span style=color:#fff>{
</span><span>        eprint!(</span><span style=color:#f1fa8c>"Error </span><span style=color:#bd93f9>{}</span><span style=color:#f1fa8c>"</span><span>, e)
</span><span>    </span><span style=color:#fff>}
</span><span style=color:#fff>}
</span></code></pre><p>I use the <a rel="nofollow noreferrer" href=https://github.com/clap-rs/clap>clap</a> crate to create the CLI. The program accepts a directory containing images to convert and an optional output directory (see more at convert_image function)<h3 id=addressing-generated-image-size-issues>Addressing generated image size issues<a aria-label="Anchor link for: addressing-generated-image-size-issues" class=zola-anchor href=#addressing-generated-image-size-issues style=visibility:hidden>#</a></h3><p>While working on converting images to WebP format, I encountered a problem: some of the converted images turned out to be larger in size than the originals. This was concerning because my goal was to reduce image size to improve website performance.<p>I realized that this happened because the image crate in this moment is only supported a <code>new_lossless</code> feature for WebP conversion. This feature maintains the same quality as the original image, sometimes resulting in larger file sizes.<p>To address this issue, I explored other options and came across the <a rel="nofollow noreferrer" href=https://github.com/jaredforth/webp>webp</a> crate.<p>This crate, built on the <code>libwebp-sys</code> and <code>image</code> crate, allows us to better encode images to WebP format with <code>quality</code> control.<p>I found that by setting the <code>quality</code> parameter to the maximum value of <code>100</code>, we could consistently generate WebP images with smaller sizes than the originals. In fact, I could reduce the image size by up to 45%.<p>To apply the <code>webp</code> crate into my code, I only needed to make a slight modification to the <code>encode_webp</code> function. Here's the updated code snippet:<pre class=language-rust data-lang=rust style=color:#f8f8f2;background-color:#282a36><code class=language-rust data-lang=rust><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>image</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>DynamicImage;
</span><span style=color:#ff79c6>use </span><span style=color:#66d9ef;text-decoration:underline>webp</span><span style=color:#ff79c6;text-decoration:underline>::</span><span style=color:#fff>{</span><span>Encoder,WebPMemory</span><span style=color:#fff>}</span><span>;
</span><span>
</span><span style=color:#ff79c6>pub </span><span style=color:#8be9fd;font-style:italic>fn </span><span style=color:#50fa7b>encode_webp</span><span>(</span><span style=color:#ffb86c;font-style:italic>image</span><span>: </span><span style=color:#ff79c6>&</span><span>DynamicImage) </span><span style=color:#ff79c6>-> </span><span style=color:#66d9ef;font-style:italic>Result</span><span style=color:#ff79c6>&LTWebPMemory, </span><span style=color:#66d9ef;font-style:italic>String</span><span style=color:#ff79c6>> </span><span style=color:#fff>{
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> encoder </span><span style=color:#ff79c6>= </span><span style=color:#66d9ef;text-decoration:underline>Encoder</span><span style=color:#ff79c6;text-decoration:underline>::</span><span>from_image(image)
</span><span>        </span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>map_err</span><span>(|</span><span style=color:#ffb86c;font-style:italic>e</span><span>| format!(</span><span style=color:#f1fa8c>"Failed to create a webp encoder: </span><span style=color:#bd93f9>{}</span><span style=color:#f1fa8c>"</span><span>, e))</span><span style=color:#ff79c6>?</span><span>;
</span><span>    </span><span style=color:#8be9fd;font-style:italic>let</span><span> webp_data </span><span style=color:#ff79c6>=</span><span> encoder</span><span style=color:#ff79c6>.</span><span style=color:#8be9fd>encode</span><span>(</span><span style=color:#bd93f9>100.0</span><span>);
</span><span>    </span><span style=color:#66d9ef;font-style:italic>Ok</span><span>(webp_data)
</span><span style=color:#fff>}
</span></code></pre><p>Now, with this program, I can quickly convert all images from my website to WebP format.<p>Here's an example of a command-line <code>webp</code> in this tool: <img alt="webp cmd" loading=lazy src=img/webp_cmd.webp><p>You can check out the full code on my GitHub repo: <a rel="nofollow noreferrer" href=https://github.com/tduyng/imgc-rs>imgc-rs</a>.<p>I think this project has a lot of potential. We can add a lot more features like batch processing, additional image format conversions, and more. All suggestions and contributions are welcome to make it even better.<p>Thank you for reading so far! I hope you found this article helpful and gained some new ideas. If you have any questions or suggestions, feel free to reach out.<div class=pagination><hr> Enjoyed this article? For more technical content on Typescript or backend development, stay updated by subcribe my blog through RSS feeds. <div class=pagination__buttons><span class="button previous"> <a href=https://tduyng2.github.io/blog/dynamic-github-profile-with-bun-typescript/> <span class=button__icon>←</span>  <span class=button__text>Dynamic Github profile with Bun and Typescript</span> </a> </span><span class="button next"> <a href=https://tduyng2.github.io/blog/full-text-rss-feeds/> <span class=button__text>My blog now offers full-text RSS feeds</span>  <span class=button__icon>→</span> </a> </span></div></div></article><div class=giscus></div><script data-repo-id="MDEwOlJlcG9zaXRvcnkyNjAzNTM0NzM=" async crossorigin data-category=General data-category-id=DIC_kwDOD4Stwc4CfSpo data-dark-theme=noborder_dark data-emit-metadata=0 data-input-position=bottom data-lang=en data-lazy-loading=true data-light-theme=noborder_light data-mapping=specific data-reactions-enabled=1 data-repo=tduyng/tduyng.github.io data-strict=1 data-term=rust-webp-transform src=https://giscus.app/client.js></script></div><footer><div class=copyright><p>© 2024 Duy NG</div><a class="instant fold" href=/tags>tags</a><a class="instant fold" href=/subscribe>subscribe</a><a class="instant fold" href=/contact>contact</a><a class="instant fold" href=/privacy>privacy</a><a class="instant fold" href=/sitemap.xml>sitemap</a><a class="instant fold" href=/atom.xml>rss</a></footer></main></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>